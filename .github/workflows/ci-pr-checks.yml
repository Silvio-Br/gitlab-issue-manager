name: ğŸ” PR Quality Checks

on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'

jobs:
  # =============================================================================
  # VÃ©rifications spÃ©cifiques aux Pull Requests
  # =============================================================================
  pr-validation:
    name: ğŸ” PR Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Validate PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "Validating PR title: $PR_TITLE"
          
          # VÃ©rifier que le titre suit les conventions
          if [[ "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore)($$.+$$)?: .+ ]]; then
            echo "âœ… PR title follows conventional commits format"
          else
            echo "âŒ PR title should follow conventional commits format"
            echo "Examples: feat: add new feature, fix(auth): resolve login issue"
            exit 1
          fi

      - name: ğŸ“ Check PR size
        run: |
          # Compter les fichiers modifiÃ©s
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | grep -o '[0-9]\+ insertions\|[0-9]\+ deletions' | grep -o '[0-9]\+' | paste -sd+ | bc || echo "0")
          
          echo "ğŸ“Š PR Statistics:"
          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"
          
          # Alerter si la PR est trop grosse
          if [ "$FILES_CHANGED" -gt 50 ] || [ "$LINES_CHANGED" -gt 1000 ]; then
            echo "âš ï¸ Large PR detected. Consider breaking it into smaller PRs."
            echo "::warning::This PR modifies $FILES_CHANGED files and $LINES_CHANGED lines. Consider splitting it."
          else
            echo "âœ… PR size is reasonable"
          fi

      - name: ğŸ” Check for sensitive files
        run: |
          echo "ğŸ” Checking for sensitive files..."
          SENSITIVE_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(env|key|pem|p12|pfx)$' || true)
          
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "âŒ Sensitive files detected:"
            echo "$SENSITIVE_FILES"
            echo "::error::Sensitive files should not be committed"
            exit 1
          else
            echo "âœ… No sensitive files detected"
          fi

      - name: ğŸ“ Check for TODO/FIXME
        run: |
          echo "ğŸ“ Checking for TODO/FIXME comments..."
          TODO_COUNT=$(git diff origin/${{ github.base_ref }}...HEAD | grep -c "TODO\|FIXME" || echo "0")
          
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "âš ï¸ Found $TODO_COUNT TODO/FIXME comments in this PR"
            echo "::warning::Consider addressing TODO/FIXME comments before merging"
          else
            echo "âœ… No TODO/FIXME comments found"
          fi

  # =============================================================================
  # Tests de compatibilitÃ© multi-environnements
  # =============================================================================
  compatibility:
    name: ğŸŒ Compatibility Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['22']
      fail-fast: false
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Test build
        run: pnpm build

      - name: ğŸ“Š Report compatibility
        run: |
          echo "âœ… Compatible with Node.js ${{ matrix.node-version }} on ${{ matrix.os }}"

  # =============================================================================
  # Analyse des performances
  # =============================================================================
  performance:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build for analysis
        run: pnpm build

      - name: ğŸ“Š Bundle analysis
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          
          # Analyser la taille des bundles
          if [ -d ".next" ]; then
            echo "Next.js build analysis:"
            find .next -name "*.js" -type f -exec ls -lh {} \; | head -10
          
            # Calculer la taille totale
            TOTAL_SIZE=$(find .next -name "*.js" -type f -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
            TOTAL_SIZE_MB=$((TOTAL_SIZE / 1024 / 1024))
          
            echo "Total bundle size: ${TOTAL_SIZE_MB}MB"
          
            if [ "$TOTAL_SIZE_MB" -gt 10 ]; then
              echo "âš ï¸ Bundle size is large (${TOTAL_SIZE_MB}MB). Consider optimization."
              echo "::warning::Bundle size is ${TOTAL_SIZE_MB}MB"
            else
              echo "âœ… Bundle size is acceptable (${TOTAL_SIZE_MB}MB)"
            fi
          fi

  # =============================================================================
  # VÃ©rification des dÃ©pendances
  # =============================================================================
  dependencies:
    name: ğŸ“¦ Dependencies Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“Š Check for outdated dependencies
        run: |
          echo "ğŸ“Š Checking for outdated dependencies..."
          pnpm outdated || echo "Some dependencies are outdated"

      - name: ğŸ” Check for unused dependencies
        run: |
          echo "ğŸ” Installing depcheck..."
          npm install -g depcheck
          
          echo "Checking for unused dependencies..."
          depcheck --json | jq '.dependencies' || echo "No unused dependencies found"

      - name: ğŸ“ˆ Dependencies summary
        run: |
          echo "ğŸ“ˆ Dependencies Summary:"
          echo "Total packages: $(jq '.dependencies | length' package.json)"
          echo "Dev packages: $(jq '.devDependencies | length' package.json)"
