name: ğŸ” CI - Branches Development

on:
  push:
    branches:
      - '**'
      - '!main'

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'

jobs:
  # =============================================================================
  # Job 1: Installation des dÃ©pendances avec cache optimisÃ©
  # =============================================================================
  install:
    name: ğŸ“¦ Install Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      pnpm-cache-key: ${{ steps.pnpm-cache-key.outputs.key }}
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Generate cache keys
        id: cache-key
        run: |
          echo "key=node-modules-${{ hashFiles('package-lock.json', 'package.json', 'pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Generate pnpm cache key
        id: pnpm-cache-key
        run: |
          echo "key=pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ—‚ï¸ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ”„ Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ steps.pnpm-cache-key.outputs.key }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: ğŸ”„ Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            node-modules-

      - name: ğŸ“¥ Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¦ Installing dependencies with pnpm..."
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ“Š Dependencies info
        run: |
          echo "ğŸ“‹ Dependency summary:"
          echo "Node version: $(node --version)"
          echo "pnpm version: $(pnpm --version)"
          echo "Package count: $(ls node_modules | wc -l)"
          echo "Cache status: ${{ steps.cache-node-modules.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"

  # =============================================================================
  # Job 2: Build de l'application
  # =============================================================================
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: install
    #strategy:
    #  matrix:
    #    build-env: [development, staging, production]
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ”„ Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ needs.install.outputs.cache-key }}

      - name: ğŸ”„ Cache Next.js build
        uses: actions/cache@v3
        with:
          path: |
            .next/cache
          key: nextjs-${{ matrix.build-env }}-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            nextjs-${{ matrix.build-env }}-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/pnpm-lock.yaml') }}-

      - name: ğŸ—ï¸ Build application (${{ matrix.build-env }})
        env:
          #NODE_ENV: ${{ matrix.build-env }}
          NEXT_TELEMETRY_DISABLED: 1
        run: |
          echo "ğŸ—ï¸ Building application for ${{ matrix.build-env }}..."
          pnpm build
          echo "âœ… Build completed successfully"

      - name: ğŸ“Š Build analysis
        run: |
          echo "ğŸ“Š Build Analysis for ${{ matrix.build-env }}:"
          echo "Build size:"
          du -sh .next/ || echo "No .next directory found"
          echo "Static files:"
          find .next/static -name "*.js" -o -name "*.css" | wc -l || echo "No static files found"

  # =============================================================================
  # Job 3: Analyse de sÃ©curitÃ©
  # =============================================================================
  security:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ”„ Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ needs.install.outputs.cache-key }}

      - name: ğŸ”’ Run security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          pnpm audit --audit-level moderate || echo "âš ï¸ Security vulnerabilities found"

      - name: ğŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: ğŸ“Š Security summary
        run: |
          echo "ğŸ“Š Security Analysis Summary:"
          echo "âœ… Dependency audit completed"
          echo "âœ… CodeQL analysis completed"

  # =============================================================================
  # Job 4: RÃ©sumÃ© final et notifications
  # =============================================================================
  summary:
    name: ğŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [install, build, security]
    if: always()
    steps:
      - name: ğŸ“‹ Generate summary
        run: |
          echo "# ğŸ“‹ CI Summary for Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Install | ${{ needs.install.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ Build | ${{ needs.build.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Security | ${{ needs.security.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ‰ Success notification
        if: needs.install.result == 'success' && needs.build.result == 'success'
        run: |
          echo "ğŸ‰ All CI checks passed successfully!"
          echo "âœ… Ready for code review and merge"

      - name: âŒ Failure notification
        if: needs.install.result == 'failure' || needs.build.result == 'failure'
        run: |
          echo "âŒ Some CI checks failed"
          echo "Please review the failed jobs and fix the issues"
          exit 1

  # =============================================================================
  # Job 5: Commentaire automatique sur PR (optionnel)
  # =============================================================================
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [install, build, security]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - name: ğŸ’¬ Comment PR with results
        uses: actions/github-script@v6
        with:
          script: |
            const results = {
              install: '${{ needs.install.result }}',
              build: '${{ needs.build.result }}',
              security: '${{ needs.security.result }}'
            };
            
            const getEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¹ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };
            
            const allPassed = Object.values(results).every(r => r === 'success');
            
            const comment = `## ğŸ” CI Results for \`${{ github.ref_name }}\`
            
            | Check | Status |
            |-------|--------|
            | ğŸ“¦ Install Dependencies | ${getEmoji(results.install)} ${results.install} |
            | ğŸ—ï¸ Build Application | ${getEmoji(results.build)} ${results.build} |
            | ğŸ”’ Security Analysis | ${getEmoji(results.security)} ${results.security} |
            
            ${allPassed ? 
              'ğŸ‰ **All checks passed!** This PR is ready for review.' : 
              'âš ï¸ **Some checks failed.** Please review and fix the issues before merging.'
            }
            
            ---
            *Automated comment by GitHub Actions*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
